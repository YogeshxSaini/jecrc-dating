"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[222],{8222:function(e,t,n){n.d(t,{h:function(){return s},x:function(){return o}});var a=n(4829),r=n(7871);class i{queueRequest(e){return new Promise((t,n)=>{this.requestQueue.push({config:e,resolve:t,reject:n})})}processQueue(e,t){console.log("[API Client] Processing queue with ".concat(this.requestQueue.length," requests")),this.requestQueue.forEach(n=>{e?n.reject(e):(t&&(n.config.headers=n.config.headers||{},n.config.headers.Authorization="Bearer ".concat(t)),n.resolve(this.client(n.config)))}),this.requestQueue=[]}getAccessToken(){return localStorage.getItem("accessToken")}getTokenExpiry(){let e=localStorage.getItem("tokenExpiry");if(e){let t=new Date(e);if(!isNaN(t.getTime()))return t}return null}setAccessToken(e){localStorage.setItem("accessToken",e)}getRefreshToken(){return localStorage.getItem("refreshToken")}setRefreshToken(e){localStorage.setItem("refreshToken",e)}clearTokens(){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("tokenExpiry"),console.log("[API Client] Tokens cleared from localStorage")}async requestVerification(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(await this.client.post("/api/auth/request-verification",{email:e,loginMode:t})).data}async verifyOTP(e,t,n,a){let i=await this.client.post("/api/auth/verify",{email:e,otp:t,password:n,displayName:a});return i.data.accessToken&&((0,r.km)(i.data.accessToken),this.setRefreshToken(i.data.refreshToken)),i.data}async login(e,t){let n=await this.client.post("/api/auth/login",{email:e,password:t});return n.data.accessToken&&((0,r.km)(n.data.accessToken),this.setRefreshToken(n.data.refreshToken)),n.data}async logout(){let e=this.getRefreshToken();await this.client.post("/api/auth/logout",{refreshToken:e}),(0,r.yE)("User logout")}async getMe(){return(await this.client.get("/api/auth/me")).data}async getMyProfile(){return(await this.client.get("/api/profile/me")).data}async updateProfile(e){return(await this.client.put("/api/profile",e)).data}async getProfile(e){return(await this.client.get("/api/profile/".concat(e))).data}async getDiscoverFeed(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(await this.client.get("/api/discover",{params:{limit:e,offset:t}})).data}async likeUser(e){return(await this.client.post("/api/likes",{toUserId:e})).data}async passUser(e){return(await this.client.post("/api/discover/pass/".concat(e))).data}async unlikeUser(e){return(await this.client.delete("/api/likes/".concat(e))).data}async getReceivedLikes(){return(await this.client.get("/api/likes/received")).data}async getMatches(){return(await this.client.get("/api/matches")).data}async getMatch(e){return(await this.client.get("/api/matches/".concat(e))).data}async getPhotoVerifications(e){return(await this.client.get("/api/admin/photo-verifications",{params:{status:e}})).data}async reviewPhotoVerification(e,t,n){return(await this.client.post("/api/admin/photo-verifications/".concat(e,"/review"),{status:t,reason:n})).data}async getReports(e){return(await this.client.get("/api/admin/reports",{params:{status:e}})).data}async banUser(e,t){return(await this.client.post("/api/admin/users/".concat(e,"/ban"),{reason:t})).data}async unbanUser(e){return(await this.client.post("/api/admin/users/".concat(e,"/unban"))).data}async getAdminStats(){return(await this.client.get("/api/admin/stats")).data}async getAdminUsers(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;return(await this.client.get("/api/admin/users",{params:{limit:e,offset:t,search:n}})).data}async reviewReport(e,t,n){return(await this.client.post("/api/admin/reports/".concat(e,"/review"),{status:t,resolution:n})).data}async getAnalytics(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;return(await this.client.get("/api/admin/analytics",{params:{days:e}})).data}async getUserActivity(e){return(await this.client.get("/api/admin/users/".concat(e,"/activity"))).data}async bulkUserAction(e,t,n){return(await this.client.post("/api/admin/users/bulk-action",{action:e,userIds:t,reason:n})).data}async broadcastNotification(e,t,n,a){return(await this.client.post("/api/admin/broadcast",{title:e,message:t,type:n,userIds:a})).data}async getAdminChats(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(await this.client.get("/api/admin/chats",{params:{limit:e,offset:t}})).data}async getAuditLogs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;return(await this.client.get("/api/admin/audit-logs",{params:{limit:e,offset:t,action:n,adminId:a}})).data}async getSystemSettings(){return(await this.client.get("/api/admin/settings")).data}async updateSystemSettings(e){return(await this.client.put("/api/admin/settings",e)).data}async getNotifications(){return(await this.client.get("/api/notifications")).data.notifications}async markNotificationAsRead(e){return(await this.client.put("/api/notifications/".concat(e,"/read"))).data}async markAllNotificationsAsRead(){return(await this.client.put("/api/notifications/read-all")).data}async deleteLike(e){return(await this.client.delete("/api/admin/likes/".concat(e))).data}async deleteMatch(e){return(await this.client.delete("/api/admin/matches/".concat(e))).data}async getAllLikes(e,t,n){let a={limit:e,offset:t};return n&&(a.search=n),(await this.client.get("/api/admin/likes",{params:a})).data}async getAllMatches(e,t,n){let a={limit:e,offset:t};return n&&(a.search=n),(await this.client.get("/api/admin/matches",{params:a})).data}async uploadPhoto(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(await this.client.post("/api/photos/upload",{imageData:e,isProfilePic:t})).data}async getPhotos(){return(await this.client.get("/api/photos")).data.photos}async updatePhoto(e,t){return(await this.client.put("/api/photos/".concat(e),t)).data}async deletePhoto(e){return(await this.client.delete("/api/photos/".concat(e))).data}constructor(){this.requestQueue=[],this.client=a.default.create({baseURL:"https://jecrc-dating-backend.onrender.com",headers:{"Content-Type":"application/json"}}),this.client.interceptors.request.use(async e=>{if((0,r.L4)(),!await (0,r.x7)())return console.error("[API Client] Token validation failed after inactivity, redirecting to login"),console.log("[API Client] Redirecting to login - Reason: Token validation failed after inactivity"),window.location.href="/login",Promise.reject(Error("Token validation failed after inactivity"));if((0,r.dV)()&&!(0,r.N7)()){console.log("[API Client] Token needs refresh before request, refreshing proactively"),(0,r.yh)(!0);try{if(!await (0,r.Ls)())return console.error("[API Client] Proactive refresh failed, redirecting to login"),(0,r.yh)(!1),console.log("[API Client] Redirecting to login - Reason: Proactive token refresh failed"),window.location.href="/login",Promise.reject(Error("Token refresh failed"));console.log("[API Client] Proactive refresh successful")}finally{(0,r.yh)(!1)}}if((0,r.N7)()){console.log("[API Client] Refresh in progress, waiting...");let e=0;for(;(0,r.N7)()&&e<1e4;)await new Promise(e=>setTimeout(e,100)),e+=100;if(e>=1e4)return console.error("[API Client] Timeout waiting for refresh to complete"),Promise.reject(Error("Token refresh timeout"))}let t=this.getAccessToken();return t&&(e.headers.Authorization="Bearer ".concat(t)),e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>e,async e=>{var t,n;let a=e.config;if((null===(t=e.response)||void 0===t?void 0:t.status)===403){let t=e.response.data,n=(null==t?void 0:t.error)||(null==t?void 0:t.message)||"";if(n.toLowerCase().includes("banned")||n.toLowerCase().includes("deactivated")||n.toLowerCase().includes("suspended")){console.log("[API Client] User banned/deactivated, clearing tokens and redirecting"),(0,r.yE)("User banned or deactivated");{let e=encodeURIComponent(n);window.location.href="/login?error=".concat(e)}return Promise.reject(e)}}if((null===(n=e.response)||void 0===n?void 0:n.status)===401&&!a._retry){if(a._retry=!0,!(0,r.dV)()){let e=this.getTokenExpiry();if(e){let t=new Date,n=e.getTime()-t.getTime();console.warn("[API Client] Server/client time disagreement detected: "+"Server returned 401 but client thinks token is valid for ".concat(Math.floor(n/1e3/60)," more minutes. ")+"Trusting server response and refreshing token.")}}if((0,r.N7)())return console.log("[API Client] Refresh in progress, queueing request"),this.queueRequest(a);(0,r.yh)(!0),console.log("[API Client] Starting token refresh due to 401");try{if(await (0,r.Ls)()){let e=this.getAccessToken();return console.log("[API Client] Token refresh successful, processing queue"),this.processQueue(null,e),e&&(a.headers.Authorization="Bearer ".concat(e)),this.client(a)}return console.error("[API Client] Token refresh failed, clearing queue and redirecting"),this.processQueue(Error("Token refresh failed"),null),console.log("[API Client] Redirecting to login - Reason: Token refresh failed after retries"),window.location.href="/login",Promise.reject(Error("Token refresh failed"))}catch(e){return console.error("[API Client] Token refresh exception:",e),this.processQueue(e,null),console.log("[API Client] Redirecting to login - Reason: Token refresh exception",e),window.location.href="/login",Promise.reject(e)}finally{(0,r.yh)(!1)}}return Promise.reject(e)})}}let o=new i,s=o},7871:function(e,t,n){n.d(t,{JW:function(){return o},L4:function(){return p},Ls:function(){return y},N7:function(){return d},QD:function(){return f},UK:function(){return h},Wm:function(){return function e(){r&&(clearTimeout(r),r=null);let t=s();if(!t)return;let n=new Date,a=t.getTime()-n.getTime()-12e4;if(a<=0){console.log("[TokenManager] Token already needs refresh, triggering immediately"),y().catch(e=>{console.error("[TokenManager] Immediate refresh failed:",e)});return}console.log("[TokenManager] Scheduling proactive refresh in ".concat(Math.floor(a/1e3/60),"m ").concat(Math.floor(a/1e3%60),"s")),r=setTimeout(()=>{console.log("[TokenManager] Proactive refresh triggered by schedule"),y().then(t=>{t&&e()}).catch(e=>{console.error("[TokenManager] Scheduled refresh failed:",e)})},a)}},dV:function(){return c},j2:function(){return m},km:function(){return l},x7:function(){return k},yE:function(){return u},yh:function(){return g}});let a=!1,r=null,i=Date.now();function o(e){try{let t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch(e){return console.error("[TokenManager] Failed to parse JWT:",e),null}}function s(){let e=localStorage.getItem("tokenExpiry");if(e){let t=new Date(e);if(!isNaN(t.getTime()))return t}let t=localStorage.getItem("accessToken");if(!t)return null;let n=o(t);return n&&n.exp?new Date(1e3*n.exp):(console.error("[TokenManager] Invalid token payload"),null)}function c(){let e=s();if(!e)return!1;let t=new Date;return e.getTime()-t.getTime()<12e4}function l(e){let t=o(e);if(!t||!t.exp){console.error("[TokenManager] Cannot store token: invalid payload");return}let n=new Date(1e3*t.exp);localStorage.setItem("accessToken",e),localStorage.setItem("tokenExpiry",n.toISOString()),console.log("[TokenManager] Token stored with expiry:",n.toISOString())}function u(e){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("tokenExpiry"),console.log("[TokenManager] Tokens cleared",e?"- Reason: ".concat(e):""),r&&(clearTimeout(r),r=null),a=!1}function d(){return a}function g(e){a=e}function h(){return r}function f(e){r&&clearTimeout(r),r=e}function p(){i=Date.now()}async function k(){if(!(Date.now()-i>3e5))return!0;if(console.log("[TokenManager] User inactive, validating token freshness"),!c())return p(),!0;console.log("[TokenManager] Token needs refresh after inactivity, refreshing"),a=!0;try{if(await y())return console.log("[TokenManager] Token refreshed successfully after inactivity"),p(),!0;return console.error("[TokenManager] Token refresh failed after inactivity"),!1}finally{a=!1}}function m(){console.log("[TokenManager] Initializing token manager"),p();let e=localStorage.getItem("accessToken");e&&(localStorage.getItem("tokenExpiry")||(console.log("[TokenManager] Token found without expiry, calculating and storing"),l(e)),c()&&console.log("[TokenManager] Token needs immediate refresh"),console.log("[TokenManager] Initialization complete"))}async function y(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=localStorage.getItem("refreshToken");if(!t)return console.error("[TokenManager] No refresh token available"),u("No refresh token available"),!1;try{let e=(await Promise.all([n.e(829),n.e(164)]).then(n.bind(n,6513))).default,{accessToken:a}=(await e.post("".concat("https://jecrc-dating-backend.onrender.com","/api/auth/refresh"),{refreshToken:t})).data;if(!a)return console.error("[TokenManager] Refresh response missing accessToken"),u("Invalid refresh response"),!1;return l(a),console.log("[TokenManager] Token refresh successful"),!0}catch(t){var a;if((null===(a=t.response)||void 0===a?void 0:a.status)===401)return console.error("[TokenManager] Refresh token invalid or expired (401)"),u("Refresh token invalid or expired"),!1;if((!t.response||[408,429,500,502,503,504].includes(t.response.status))&&e<2){let n=1e3*Math.pow(2,e);return console.warn("[TokenManager] Network error during refresh, retrying in ".concat(n,"ms (attempt ").concat(e+1,"/2)"),t.message),await new Promise(e=>setTimeout(e,n)),y(e+1)}return console.error("[TokenManager] Token refresh failed after ".concat(e+1," attempt(s)"),t.message),u("Token refresh failed"),!1}}}}]);