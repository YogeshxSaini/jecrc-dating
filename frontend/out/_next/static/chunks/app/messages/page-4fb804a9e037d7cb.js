(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[750],{4926:function(e,t,n){Promise.resolve().then(n.bind(n,1925))},1925:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return g}});var r=n(7437),s=n(2265),a=n(4033),l=n(4337);let o=(0,s.createContext)(null),c=()=>{let e=(0,s.useContext)(o);if(!e)throw Error("useMessaging must be used within MessagingProvider");return e},i=e=>{let{children:t}=e,[n,a]=(0,s.useState)(null),[c,i]=(0,s.useState)("disconnected"),[d,u]=(0,s.useState)([]),[m,h]=(0,s.useState)([]),[f,g]=(0,s.useState)({}),x=(0,s.useRef)(),p=(0,s.useRef)(0),v=(0,s.useRef)(new Set),j=(0,s.useRef)(new Set),b=(0,s.useRef)(new Set),y=e=>Math.min(1e3*Math.pow(2,e),3e4),N=(0,s.useCallback)(()=>{let e=localStorage.getItem("accessToken");if(!e){console.log("No access token, skipping socket connection");return}e.startsWith("Bearer ")&&(e=e.slice(7));let t=["localhost","127.0.0.1","[::1]","0.0.0.0"].includes(window.location.hostname)?"http://localhost:4000":"https://jecrc-dating-backend.onrender.com";console.log("Initializing socket connection to:",t),i("connecting");let n=(0,l.io)(t,{auth:{token:e},transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:3e4,reconnectionAttempts:1/0,timeout:6e4});return n.on("connect",()=>{console.log("Socket connected:",n.id),i("connected"),p.current=0,x.current&&clearTimeout(x.current)}),n.on("disconnect",e=>{console.log("Socket disconnected:",e),i("disconnected")}),n.on("connect_error",e=>{console.error("Socket connection error:",e),i("reconnecting"),p.current++;let t=y(p.current);console.log("Reconnecting in ".concat(t,"ms (attempt ").concat(p.current,")")),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{n.disconnected&&(console.log("Attempting reconnection..."),n.connect())},t)}),n.on("new_message",e=>{console.log("Received new message:",e),u(t=>[...t,e]),v.current.forEach(t=>t(e))}),n.on("message_read",e=>{console.log("Message read:",e),u(t=>t.map(t=>t.matchId!==e.matchId||t.readAt?t:{...t,readAt:e.readAt})),b.current.forEach(t=>t(e))}),n.on("user_typing",e=>{console.log("User typing:",e),h(t=>t.find(t=>t.matchId===e.matchId&&t.userId===e.userId)?t:[...t,e]),j.current.forEach(t=>t(e))}),n.on("user_stopped_typing",e=>{console.log("User stopped typing:",e),h(t=>t.filter(t=>!(t.matchId===e.matchId&&t.userId===e.userId)))}),n.on("user_online",e=>{console.log("User online:",e),g(t=>({...t,[e.userId]:!0}))}),n.on("user_offline",e=>{console.log("User offline:",e),g(t=>({...t,[e.userId]:!1}))}),a(n),()=>{console.log("Cleaning up socket connection"),x.current&&clearTimeout(x.current),n.close()}},[]);(0,s.useEffect)(()=>{let e=N(),t=()=>{console.log("Token refreshed, reconnecting socket..."),n&&n.disconnect(),N()};return window.addEventListener("tokenRefreshed",t),()=>{null==e||e(),window.removeEventListener("tokenRefreshed",t)}},[N]);let k=(0,s.useCallback)((e,t)=>{if(!n||!n.connected){console.error("Socket not connected, cannot send message");return}n.emit("send_message",{matchId:e,content:t},e=>{(null==e?void 0:e.error)?console.error("Error sending message:",e.error):console.log("Message sent successfully:",e)})},[n]),w=(0,s.useCallback)(e=>{if(!n||!n.connected){console.error("Socket not connected, cannot mark as read");return}n.emit("mark_as_read",{matchId:e})},[n]),I=(0,s.useCallback)(e=>{n&&n.connected&&n.emit("typing",{matchId:e})},[n]),T=(0,s.useCallback)(e=>{n&&n.connected&&n.emit("stop_typing",{matchId:e})},[n]),S=(0,s.useCallback)(e=>(v.current.add(e),()=>{v.current.delete(e)}),[]),D=(0,s.useCallback)(e=>(j.current.add(e),()=>{j.current.delete(e)}),[]),M=(0,s.useCallback)(e=>(b.current.add(e),()=>{b.current.delete(e)}),[]);return(0,r.jsx)(o.Provider,{value:{socket:n,connectionStatus:c,messages:d,typingUsers:m,onlineStatus:f,sendMessage:k,markAsRead:w,startTyping:I,stopTyping:T,addMessageListener:S,addTypingListener:D,addReadReceiptListener:M},children:t})};var d=n(7871);let u=e=>{let{onSelectChat:t,selectedMatchId:n}=e,[a,l]=(0,s.useState)([]),[o,i]=(0,s.useState)(!0),[u,m]=(0,s.useState)(null),[h,f]=(0,s.useState)(null),{connectionStatus:g,onlineStatus:x,addMessageListener:p,addReadReceiptListener:v}=c();(0,s.useEffect)(()=>{let e=localStorage.getItem("accessToken");if(e){let t=(0,d.JW)(e);t?f(t.id):console.error("Error decoding token in ChatList")}j()},[]),(0,s.useEffect)(()=>p(e=>{l(t=>t.map(t=>{if(t.matchId===e.matchId){var r,s;let a=e.senderId===t.user.id&&n!==t.matchId;return{...t,lastMessage:{id:e.id,content:e.content,senderId:e.senderId,createdAt:e.createdAt,sender:{displayName:(null===(r=e.sender)||void 0===r?void 0:r.displayName)||(null===(s=e.sender)||void 0===s?void 0:s.name)||"User"}},unreadCount:a?t.unreadCount+1:t.unreadCount}}return t}))}),[p,n]);let j=async()=>{try{i(!0);let e=localStorage.getItem("accessToken"),t=["localhost","127.0.0.1","[::1]","0.0.0.0"].includes(window.location.hostname),n=(null==e?void 0:e.startsWith("Bearer "))?e:"Bearer ".concat(e),r=await fetch("".concat(t?"http://localhost:4000":"https://jecrc-dating-backend.onrender.com","/api/messages/matches"),{headers:{Authorization:n}}),s=await r.json();s.success?l(s.matches):m(s.error||"Failed to fetch matches")}catch(e){console.error("Error fetching matches:",e),m("Failed to load conversations")}finally{i(!1)}},b=e=>{let t=new Date(e),n=new Date().getTime()-t.getTime(),r=Math.floor(n/6e4),s=Math.floor(n/36e5),a=Math.floor(n/864e5);return r<1?"Just now":r<60?"".concat(r,"m"):s<24?"".concat(s,"h"):a<7?"".concat(a,"d"):t.toLocaleDateString()},y=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;return e.length<=t?e:e.substring(0,t)+"..."};return o?(0,r.jsxs)("div",{className:"flex flex-col h-full bg-white border-r",children:[(0,r.jsxs)("div",{className:"p-4 border-b",children:[(0,r.jsx)("h2",{className:"text-xl font-bold",children:"Messages"}),(0,r.jsxs)("div",{className:"text-xs mt-1 text-gray-500",children:["connected"===g&&"\uD83D\uDFE2 Connected","connecting"===g&&"\uD83D\uDFE1 Connecting...","reconnecting"===g&&"\uD83D\uDFE0 Reconnecting...","disconnected"===g&&"\uD83D\uDD34 Disconnected"]})]}),(0,r.jsx)("div",{className:"flex items-center justify-center flex-1",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"})})]}):u?(0,r.jsxs)("div",{className:"flex flex-col h-full bg-white border-r",children:[(0,r.jsx)("div",{className:"p-4 border-b",children:(0,r.jsx)("h2",{className:"text-xl font-bold",children:"Messages"})}),(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center flex-1 p-4",children:[(0,r.jsx)("p",{className:"text-red-500 text-center",children:u}),(0,r.jsx)("button",{onClick:j,className:"mt-4 px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600",children:"Retry"})]})]}):(0,r.jsxs)("div",{className:"flex flex-col h-full bg-white border-r",children:[(0,r.jsxs)("div",{className:"p-4 border-b",children:[(0,r.jsx)("h2",{className:"text-xl font-bold",children:"Messages"}),(0,r.jsxs)("div",{className:"text-xs mt-1 text-gray-500",children:["connected"===g&&"\uD83D\uDFE2 Connected","connecting"===g&&"\uD83D\uDFE1 Connecting...","reconnecting"===g&&"\uD83D\uDFE0 Reconnecting...","disconnected"===g&&"\uD83D\uDD34 Disconnected"]})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===a.length?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[(0,r.jsx)("p",{className:"text-gray-500",children:"No matches yet"}),(0,r.jsx)("p",{className:"text-sm text-gray-400 mt-2",children:"Start swiping to find your match!"})]}):a.map(e=>{let s=x[e.user.id]||!1,a=n===e.matchId;return(0,r.jsx)("div",{onClick:()=>{t(e.matchId,e.user),e.unreadCount>0&&l(t=>t.map(t=>t.matchId===e.matchId?{...t,unreadCount:0}:t))},className:"p-4 border-b cursor-pointer transition-colors ".concat(a?"bg-pink-50":"hover:bg-gray-50"),children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,r.jsx)("div",{className:"w-14 h-14 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-xl overflow-hidden",children:e.user.profileImage?(0,r.jsx)("img",{src:e.user.profileImage,alt:e.user.displayName,className:"w-full h-full object-cover"}):e.user.displayName.charAt(0).toUpperCase()}),s&&(0,r.jsx)("div",{className:"absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"})]}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 truncate",children:e.user.displayName}),e.lastMessage&&(0,r.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:b(e.lastMessage.createdAt)})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:e.user.department&&e.user.year&&(0,r.jsxs)("span",{children:[e.user.department," • Year ",e.user.year]})}),e.lastMessage?(0,r.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 truncate",children:y(e.lastMessage.content)}),e.unreadCount>0&&(0,r.jsx)("span",{className:"flex-shrink-0 ml-2 bg-pink-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:e.unreadCount>9?"9+":e.unreadCount})]}):(0,r.jsx)("p",{className:"text-sm text-gray-400 italic mt-1",children:"Start a conversation..."})]})]})},e.matchId)})})]})},m=e=>{let{onSendMessage:t,matchId:n}=e,[a,l]=(0,s.useState)(""),[o,i]=(0,s.useState)(!1),d=(0,s.useRef)(null),u=(0,s.useRef)(),{startTyping:m,stopTyping:h,connectionStatus:f}=c();(0,s.useEffect)(()=>{d.current&&(d.current.style.height="auto",d.current.style.height=d.current.scrollHeight+"px")},[a]);let g=e=>{e.preventDefault();let r=a.trim();r&&(o&&(i(!1),h(n)),u.current&&clearTimeout(u.current),t(r),l(""),d.current&&(d.current.style.height="auto"))},x="connected"!==f;return(0,r.jsxs)("div",{className:"bg-white border-t p-4",children:[(0,r.jsxs)("form",{onSubmit:g,className:"flex items-end gap-2",children:[(0,r.jsxs)("div",{className:"flex-1 relative",children:[(0,r.jsx)("textarea",{ref:d,value:a,onChange:e=>{l(e.target.value),e.target.value.trim()&&!o&&(i(!0),m(n)),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{o&&(i(!1),h(n))},2e3)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g(e))},placeholder:x?"Connecting...":"Type a message...",disabled:x,className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-full resize-none focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed max-h-32 overflow-y-auto text-gray-900 placeholder-gray-400",rows:1,style:{minHeight:"48px"}}),(0,r.jsx)("button",{type:"button",className:"absolute right-3 bottom-3 text-gray-400 hover:text-gray-600 transition-colors",disabled:x,children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})})]}),(0,r.jsx)("button",{type:"submit",disabled:!a.trim()||x,className:"flex-shrink-0 w-12 h-12 bg-gradient-to-br from-pink-500 to-purple-500 text-white rounded-full flex items-center justify-center hover:from-pink-600 hover:to-purple-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:from-pink-500 disabled:hover:to-purple-500",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]}),x&&(0,r.jsxs)("div",{className:"mt-2 text-xs text-center text-orange-500",children:["connecting"===f&&"Connecting to server...","reconnecting"===f&&"Reconnecting...","disconnected"===f&&"Disconnected. Messages will be sent when reconnected."]})]})},h=e=>{let{matchId:t,user:n,currentUserId:a}=e,[l,o]=(0,s.useState)([]),[i,d]=(0,s.useState)(!0),[u,h]=(0,s.useState)(null),[f,g]=(0,s.useState)(!1),x=(0,s.useRef)(null),p=(0,s.useRef)(null),{sendMessage:v,markAsRead:j,addMessageListener:b,addTypingListener:y,typingUsers:N,onlineStatus:k}=c();(0,s.useEffect)(()=>{w(),j(t)},[t]),(0,s.useEffect)(()=>b(e=>{e.matchId===t&&(o(t=>{var r,s,a,l,o;if(t.find(t=>t.id===e.id))return t;let c=e.senderId===n.id?n.profileImage:null!==(o=null===(r=e.sender)||void 0===r?void 0:r.profileImage)&&void 0!==o?o:null;return[...t,{id:e.id,matchId:e.matchId,senderId:e.senderId,content:e.content,readAt:e.readAt,createdAt:e.createdAt,sender:{id:(null===(s=e.sender)||void 0===s?void 0:s.id)||e.senderId,displayName:(null===(a=e.sender)||void 0===a?void 0:a.displayName)||(null===(l=e.sender)||void 0===l?void 0:l.name)||n.displayName,profileImage:c}}]}),e.senderId===n.id&&setTimeout(()=>j(t),100))}),[t,b,j,n,a]);let w=async()=>{try{d(!0),h(null);let e=localStorage.getItem("accessToken"),n=["localhost","127.0.0.1","[::1]","0.0.0.0"].includes(window.location.hostname),r=(null==e?void 0:e.startsWith("Bearer "))?e:"Bearer ".concat(e),s=await fetch("".concat(n?"http://localhost:4000":"https://jecrc-dating-backend.onrender.com","/api/messages/").concat(t),{headers:{Authorization:r}}),a=await s.json();if(a.success){let e=a.messages.map(e=>{var t;return{id:e.id,matchId:e.matchId,senderId:e.senderId,content:e.content,readAt:e.readAt,createdAt:e.createdAt,sender:{id:e.sender.id,displayName:e.sender.displayName,profileImage:null!==(t=e.sender.profileImage)&&void 0!==t?t:null}}});o(e),g(a.hasMore)}else h(a.error||"Failed to fetch messages")}catch(e){console.error("Error fetching messages:",e),h("Failed to load messages")}finally{d(!1)}},I=()=>{var e;null===(e=x.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},T=e=>{let t=new Date(e),n=Math.floor((new Date().getTime()-t.getTime())/864e5);return 0===n?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===n?"Yesterday "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n<7?t.toLocaleDateString([],{weekday:"short"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},S=k[n.id]||!1,D=N.some(e=>e.matchId===t&&e.userId===n.id);return((0,s.useEffect)(()=>{I()},[l,D]),i)?(0,r.jsxs)("div",{className:"flex flex-col h-full w-full bg-gray-50",children:[(0,r.jsxs)("div",{className:"bg-white border-b p-4 flex items-center gap-3",children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold overflow-hidden",children:n.profileImage?(0,r.jsx)("img",{src:n.profileImage,alt:n.displayName,className:"w-full h-full object-cover"}):n.displayName.charAt(0).toUpperCase()})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h2",{className:"font-semibold text-gray-900",children:n.displayName}),n.department&&n.year&&(0,r.jsxs)("p",{className:"text-sm text-gray-500",children:[n.department," • Year ",n.year]})]})]}),(0,r.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"})})]}):u?(0,r.jsxs)("div",{className:"flex flex-col h-full w-full bg-gray-50",children:[(0,r.jsxs)("div",{className:"bg-white border-b p-4 flex items-center gap-3",children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold overflow-hidden",children:n.profileImage?(0,r.jsx)("img",{src:n.profileImage,alt:n.displayName,className:"w-full h-full object-cover"}):n.displayName.charAt(0).toUpperCase()})}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)("h2",{className:"font-semibold text-gray-900",children:n.displayName})})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center p-4",children:[(0,r.jsx)("p",{className:"text-red-500 text-center",children:u}),(0,r.jsx)("button",{onClick:w,className:"mt-4 px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600",children:"Retry"})]})]}):(0,r.jsxs)("div",{className:"flex flex-col h-full w-full bg-gray-50",children:[(0,r.jsxs)("div",{className:"bg-white border-b p-4 flex items-center gap-3",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold overflow-hidden",children:n.profileImage?(0,r.jsx)("img",{src:n.profileImage,alt:n.displayName,className:"w-full h-full object-cover"}):n.displayName.charAt(0).toUpperCase()}),S&&(0,r.jsx)("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h2",{className:"font-semibold text-gray-900",children:n.displayName}),(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[S?(0,r.jsx)("span",{className:"text-green-600",children:"Online"}):(0,r.jsx)("span",{children:"Offline"}),n.department&&n.year&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{children:"•"}),(0,r.jsxs)("span",{children:[n.department," • Year ",n.year]})]})]})]})]}),(0,r.jsx)("div",{ref:p,className:"flex-1 overflow-y-auto p-4 space-y-1",children:0===l.length?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[(0,r.jsx)("div",{className:"w-20 h-20 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-3xl mb-4",children:"\uD83D\uDCAC"}),(0,r.jsx)("p",{className:"text-gray-500 font-medium",children:"No messages yet"}),(0,r.jsxs)("p",{className:"text-sm text-gray-400 mt-2",children:["Say hi to ",n.displayName," to start the conversation!"]})]}):(0,r.jsxs)(r.Fragment,{children:[l.map((e,t)=>{let n=e.senderId===a,s=0===t||l[t-1].senderId!==e.senderId;return(0,r.jsxs)("div",{className:"flex ".concat(n?"justify-end":"justify-start"," gap-2 ").concat(s?"mt-3":"mt-0.5"),children:[!n&&s&&(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-sm font-bold overflow-hidden flex-shrink-0",children:e.sender.profileImage?(0,r.jsx)("img",{src:e.sender.profileImage,alt:e.sender.displayName,className:"w-full h-full object-cover"}):e.sender.displayName.charAt(0).toUpperCase()}),!n&&!s&&(0,r.jsx)("div",{className:"w-8"}),(0,r.jsxs)("div",{className:"max-w-[70%] ".concat(n?"items-end":"items-start"),children:[(0,r.jsx)("div",{className:"rounded-2xl px-4 py-2 ".concat(n?"bg-gradient-to-br from-pink-500 to-purple-500 text-white":"bg-white text-gray-900"),children:(0,r.jsx)("p",{className:"text-sm whitespace-pre-wrap break-words",children:e.content})}),(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-1 px-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500",children:T(e.createdAt)}),n&&e.readAt&&(0,r.jsx)("span",{className:"text-xs text-blue-500",children:"✓✓"})]})]})]},e.id)}),D&&(0,r.jsxs)("div",{className:"flex justify-start gap-2 mt-3",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-sm font-bold overflow-hidden flex-shrink-0",children:n.profileImage?(0,r.jsx)("img",{src:n.profileImage,alt:n.displayName,className:"w-full h-full object-cover"}):n.displayName.charAt(0).toUpperCase()}),(0,r.jsx)("div",{className:"bg-white rounded-2xl px-4 py-2",children:(0,r.jsxs)("div",{className:"flex gap-1",children:[(0,r.jsx)("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,r.jsx)("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,r.jsx)("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]}),(0,r.jsx)("div",{ref:x})]})}),(0,r.jsx)(m,{onSendMessage:e=>{v(t,e)},matchId:t})]})},f=()=>{let[e,t]=(0,s.useState)(null),[n,l]=(0,s.useState)(null),[o,c]=(0,s.useState)(null),i=(0,a.useRouter)();return(0,s.useEffect)(()=>{let e=localStorage.getItem("accessToken");if(!e){i.push("/login");return}let t=(0,d.JW)(e);t?c(t.id):(console.error("Error decoding token: Invalid payload"),i.push("/login"))},[i]),(0,r.jsxs)("div",{className:"fixed inset-0 flex bg-gray-100",children:[(0,r.jsx)("div",{className:"w-full md:w-96 flex-shrink-0 h-full",children:(0,r.jsx)(u,{onSelectChat:(e,n)=>{t(e),l(n)},selectedMatchId:e})}),(0,r.jsx)("div",{className:"flex-1 hidden md:flex h-full",children:e&&n?(0,r.jsx)(h,{matchId:e,user:n,currentUserId:o||void 0}):(0,r.jsx)("div",{className:"flex flex-col items-center justify-center w-full bg-gray-50",children:(0,r.jsxs)("div",{className:"text-center max-w-md px-4",children:[(0,r.jsx)("div",{className:"w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-6xl",children:"\uD83D\uDCAC"}),(0,r.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Select a conversation"}),(0,r.jsx)("p",{className:"text-gray-500",children:"Choose a match from the list to start chatting"})]})})}),e&&n&&(0,r.jsxs)("div",{className:"fixed inset-0 z-50 bg-white md:hidden",children:[(0,r.jsxs)("div",{className:"flex items-center p-4 border-b bg-white",children:[(0,r.jsx)("button",{onClick:()=>{t(null),l(null)},className:"mr-3 text-gray-600 hover:text-gray-900",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsx)("h1",{className:"text-lg font-semibold",children:"Back to conversations"})]}),(0,r.jsx)("div",{className:"h-[calc(100vh-64px)]",children:(0,r.jsx)(h,{matchId:e,user:n,currentUserId:o||void 0})})]})]})};function g(){return(0,r.jsx)(i,{children:(0,r.jsx)(f,{})})}},7871:function(e,t,n){"use strict";n.d(t,{JW:function(){return l},L4:function(){return g},Ls:function(){return v},N7:function(){return u},QD:function(){return f},UK:function(){return h},Wm:function(){return function e(){s&&(clearTimeout(s),s=null);let t=o();if(!t)return;let n=new Date,r=t.getTime()-n.getTime()-12e4;if(r<=0){console.log("[TokenManager] Token already needs refresh, triggering immediately"),v().catch(e=>{console.error("[TokenManager] Immediate refresh failed:",e)});return}console.log("[TokenManager] Scheduling proactive refresh in ".concat(Math.floor(r/1e3/60),"m ").concat(Math.floor(r/1e3%60),"s")),s=setTimeout(()=>{console.log("[TokenManager] Proactive refresh triggered by schedule"),v().then(t=>{t&&e()}).catch(e=>{console.error("[TokenManager] Scheduled refresh failed:",e)})},r)}},dV:function(){return c},j2:function(){return p},km:function(){return i},x7:function(){return x},yE:function(){return d},yh:function(){return m}});let r=!1,s=null,a=Date.now();function l(e){try{let t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch(e){return console.error("[TokenManager] Failed to parse JWT:",e),null}}function o(){let e=localStorage.getItem("tokenExpiry");if(e){let t=new Date(e);if(!isNaN(t.getTime()))return t}let t=localStorage.getItem("accessToken");if(!t)return null;let n=l(t);return n&&n.exp?new Date(1e3*n.exp):(console.error("[TokenManager] Invalid token payload"),null)}function c(){let e=o();if(!e)return!1;let t=new Date;return e.getTime()-t.getTime()<12e4}function i(e){let t=l(e);if(!t||!t.exp){console.error("[TokenManager] Cannot store token: invalid payload");return}let n=new Date(1e3*t.exp);localStorage.setItem("accessToken",e),localStorage.setItem("tokenExpiry",n.toISOString()),console.log("[TokenManager] Token stored with expiry:",n.toISOString())}function d(e){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("tokenExpiry"),console.log("[TokenManager] Tokens cleared",e?"- Reason: ".concat(e):""),s&&(clearTimeout(s),s=null),r=!1}function u(){return r}function m(e){r=e}function h(){return s}function f(e){s&&clearTimeout(s),s=e}function g(){a=Date.now()}async function x(){if(!(Date.now()-a>3e5))return!0;if(console.log("[TokenManager] User inactive, validating token freshness"),!c())return g(),!0;console.log("[TokenManager] Token needs refresh after inactivity, refreshing"),r=!0;try{if(await v())return console.log("[TokenManager] Token refreshed successfully after inactivity"),g(),!0;return console.error("[TokenManager] Token refresh failed after inactivity"),!1}finally{r=!1}}function p(){console.log("[TokenManager] Initializing token manager"),g();let e=localStorage.getItem("accessToken");e&&(localStorage.getItem("tokenExpiry")||(console.log("[TokenManager] Token found without expiry, calculating and storing"),i(e)),c()&&console.log("[TokenManager] Token needs immediate refresh"),console.log("[TokenManager] Initialization complete"))}async function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=localStorage.getItem("refreshToken");if(!t)return console.error("[TokenManager] No refresh token available"),d("No refresh token available"),!1;try{let e=(await Promise.all([n.e(829),n.e(164)]).then(n.bind(n,6513))).default,{accessToken:r}=(await e.post("".concat("https://jecrc-dating-backend.onrender.com","/api/auth/refresh"),{refreshToken:t})).data;if(!r)return console.error("[TokenManager] Refresh response missing accessToken"),d("Invalid refresh response"),!1;return i(r),console.log("[TokenManager] Token refresh successful"),!0}catch(t){var r;if((null===(r=t.response)||void 0===r?void 0:r.status)===401)return console.error("[TokenManager] Refresh token invalid or expired (401)"),d("Refresh token invalid or expired"),!1;if((!t.response||[408,429,500,502,503,504].includes(t.response.status))&&e<2){let n=1e3*Math.pow(2,e);return console.warn("[TokenManager] Network error during refresh, retrying in ".concat(n,"ms (attempt ").concat(e+1,"/2)"),t.message),await new Promise(e=>setTimeout(e,n)),v(e+1)}return console.error("[TokenManager] Token refresh failed after ".concat(e+1," attempt(s)"),t.message),d("Token refresh failed"),!1}}}},function(e){e.O(0,[532,971,458,744],function(){return e(e.s=4926)}),_N_E=e.O()}]);